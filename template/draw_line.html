<!DOCTYPE html>
<html>

<head>
    <title>Valve Mapping</title>
    {% load static %}
    <style>
       
    </style>
    {% comment %} <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script> {% endcomment %}

    <script src="{% static '/js/drawline.js' %}"></script>

    <link rel="stylesheet" href="{% static '/css/style.css' %}">

    
  
     <!-- Font Awesome -->
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
     <!-- Google Fonts -->
     <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
 
     <!-- Font Awesome -->
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
     <!-- Google Fonts -->
     <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
     <!-- MDB -->
     <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.1.0/mdb.min.css" rel="stylesheet" />


     <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
     

</head>

<body >


    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary ">
        <!-- Container wrapper -->
        <div class="container-fluid mx-1">
          <!-- Toggle button -->
          <button
            data-mdb-collapse-init
            class="navbar-toggler"
            type="button"
            data-mdb-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i class="fas fa-bars"></i>
          </button>
      
          <!-- Collapsible wrapper -->
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Navbar brand -->
            <a class="navbar-brand mt-2 mt-lg-0" href="#">
              <img
                src="{% static 'logo.png' %}"
                height="30"
                alt="MDB Logo"
                loading="lazy"
              />
            </a>
            <!-- Left links -->
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link" href="">All Tanks</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/draw_line">Draw Line</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/logout">logout</a>
              </li>
            </ul>
            <!-- Left links -->
          </div>
          <!-- Collapsible wrapper -->
      
          <!-- Right elements -->
          <div class="d-flex align-items-center">
            <!-- Icon -->
            <a class="text-reset me-3" href="#">
              <i class="fas fa-gear"></i>
            </a>
      
            <!-- Notifications -->
            <div class="dropdown">
              <a
                data-mdb-dropdown-init
                class="text-reset me-3 dropdown-toggle hidden-arrow"
                href="#"
                id="navbarDropdownMenuLink"
                role="button"
                aria-expanded="false"
              >
                <i class="fas fa-bell"></i>
                <span class="badge rounded-pill badge-notification bg-danger">1</span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdownMenuLink"
              >
                <li>
                  <a class="dropdown-item" href="#">Some news</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Another news</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Something else here</a>
                </li>
              </ul>
            </div>
            <!-- Avatar -->
            <div class="dropdown">
              <a
                data-mdb-dropdown-init
                class="dropdown-toggle d-flex align-items-center hidden-arrow"
                href="#"
                id="navbarDropdownMenuAvatar"
                role="button"
                aria-expanded="false"
              >
                <img
                  src="https://t4.ftcdn.net/jpg/02/15/84/43/360_F_215844325_ttX9YiIIyeaR7Ne6EaLLjMAmy4GvPC69.jpg"
                  class="rounded-circle"
                  height="25"
                  alt="Black and White Portrait of a Man"
                  loading="lazy"
                />
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdownMenuAvatar"
              >
                <li>
                  <a class="dropdown-item" href="#">My profile</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Settings</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Logout</a>
                </li>
              </ul>
            </div>
          </div>
          <!-- Right elements -->
        </div>
        <!-- Container wrapper -->
      </nav>
      <!-- Navbar -->
    


    



    <div id="map" class="container-fluid p-0 m-0"></div>





    <div class="fixed-bottom mx-2 container-fluid  "  style="background:White; padding:10px;">
        

        <div  id="controls " style="">
            <label>Select location type:</label>
            <select id="locationType" >
                <option value="valve">Valve</option>
                <option value="branch">Branch</option>
                <option value="pipe">Pipe</option>
                <option value="switch_valve">Switch Valve</option>

            </select>
        </div>

       


        
        <button class="btn btn-outline-dark my-2" onclick="undo()"><span class="fa fa-undo"></button>
        <button class="btn btn-outline-dark my-2" onclick="redo()"><span class="fa fa-redo"></button>
        <button class="btn btn-danger my-2" onclick="clearMarkers()">Clear All</button>
    
        <button class="btn btn-primary my-2" onclick="location.reload();">Refresh</button>
    
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
    
    
        <button class="btn btn-success my-2" onclick="displayResults()">Save</button>
        <button class="btn btn-info my-2" onclick="extend_path()">Extend</button>
       
    
        <!-- New button to save branch -->
        <button class="btn btn-warning my-2" onclick="saveBranch()">Save Branch</button>
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        <button class="btn btn-danger my-2" onclick="delete_marker()">Delete</button>

        <!-- Use a button to open the snackbar -->
        


        {% comment %} marker {% endcomment %}

        <div id="pipeModal" class="modal">
            <div class="modal-content">
              <span class="close">&times;</span>
              <label for="pipeType">Pipe Material:</label>

            

            <select id="pipeType" required>
                <option value="CI" > CI</option>
                <option value="PVC" > PVC</option>
                <option value="MS" > MS</option>
                <option value="HDP" > HDP</option>
                <option value="DI" > DI</option>
                <option value="RCP" > RCP</option>
                <option value="Other" > Other</option>
            </select>



              <label for="pipeDiameter">Pipe Diameter:</label>
              <input required type="text" id="pipeDiameter">
              <button id="savePipeInfo">Done</button>
            </div>
          </div>

          



          <div id="vModal" class="modal">
            <div class="modal-content">
              <span class="close">&times;</span>
              <label for="valve_type">Valve Type:</label>
             

              <select id="valve_type">
                <option value="RCP" > RCP</option>
                <option value="Foot Valve" > Foot Valve</option>
                <option value="Actuator Valve" > Actuator Valve</option>
                <option value="Butterfly Valve" > Butterfly Valve</option>
                <option value="Gate Valve" > Gate Valve</option>
                <option value="Pressure Relief Valve" > Pressure Relief Valve</option>
                <option value="Check Valve" > Check Valve</option> 
                <option value="Position Valve" > Position Valve</option> 
                <option value="Flange Valve" > Flange Valve</option> 
                <option value="Knife Valve" >Knife Valve </option> 
                <option value="Other" >Other </option> 
              </select>
                 

                <label for="valve_key_size">Valve Type:</label>


              <input required type="text" id="valve_key_size">

              <label for="valve_diameter">Valve Diameter:</label>
              <input required type="text" id="valve_diameter">

              <button id="savevInfo">Done</button>
            </div>
          </div>
          
      
        

        </div>

    
<style>
    .modal {
        display: none; /* Hide the modal by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
      }
      
      .modal-content {
        background-color: #fefefe;
        margin: 5% auto; 15% from the top and centered horizontally */
        padding: 20px;
        border: 1px solid #888;
        width: 50%; /* Set the width to 50% */
      }
      
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      
      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      
</style>



<script>

    

    var map;
    var markers = [];
    var lines = [];
    var undoStack = [];
    var redoStack = [];
    var latitudeList = [];
    var longitudeList = [];
    var type = [];

    var positions = [];

    var currentMarkerType; // Global variable to store the type of the current marker


    //for index and path

    var up_index;
    var up_path_id;
    var extend_signal;

    var is_tank;

    var clicked_branch;

    var selectedMarkersData;

    var pipe_material = [];
    var pipe_diameter = [];

    var valve_type= [];
    var valve_diameter = [];
    var valve_key_size = [];

    var selectedMarkers = []; // Array to store selected markers

    
    
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {
                lat: 20.9025, // Latitude of Dhule, Maharashtra
                lng: 74.7774 // Longitude of Dhule, Maharashtra
            },
            zoom: 13,
            mapTypeControl: true,
            mapTypeId: google.maps.MapTypeId.HYBRID
        });

        fetchStoredMarkers();
        addBranchMarkerListeners();

        google.maps.event.addListener(map, 'click', function (event) {
            var locationType = document.getElementById('locationType').value;
            if (locationType === 'cancel') {
                return;
            }

            currentMarkerType = locationType; // Update the currentMarkerType

            addMarker(event.latLng, locationType);


        });



    }

    


    //show stored markers

    function fetchStoredMarkers() {
        fetch('/get_markers')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.markers.forEach(marker => {
                        addStoredMarker(marker.latitude, marker.longitude, marker.type, marker.path_id, marker.point_id);
                        drawLinesBetweenMarkers(data.markers_by_path);

                    });


                    // Draw lines between markers
                    drawTanksOnMap(data.all_tanks);
                    drawjwOnMap(data.all_jw);
                    drawwtpOnMap(data.all_wtp);
                    drawboosterOnMap(data.all_booster);
                    

                    // Draw lines between markers


                } else {
                    console.error('Error fetching stored markers:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching stored markers:', error);
            });
    }


    //tanks

    function drawTanksOnMap(tanks) {
        tanks.forEach(tank => {
            // Create a marker for each tank
            var tankMarker = new google.maps.Marker({
                position: { lat: parseFloat(tank.latitude), lng: parseFloat(tank.longitude) },
                map: map,
                title:  "Number: " + tank.tank_no + "\n" + "Name: " + tank.owt_tank_name + "\n" + "Position :" + tank.owt_position + "\n" + "Address: " + tank.owt_address,
                icon: '{% static 'tank.png' %}',  // Use the appropriate tank icon
                // You may customize other properties of the marker as needed
            });

          
            // Add click event listener to the tank marker
            tankMarker.addListener('click', function() {
                //alert("Tank selected: " );
                if (confirm("Do You Want To Select This Tank ?")) {
                // Clear previous lines if any
                //clearLines();
    
                // Add the tank marker as the first marker
                selectedMarkers = [tankMarker];
                currentMarkerType = "tank";

                pipe_material.push(null);
                pipe_diameter.push(null);

                valve_diameter.push(null);
                valve_key_size.push(null);
                valve_type.push(null);

                // Start drawing a line from this tank
                startLineFromTank(tankMarker.getPosition());
                }
                else{

                }
                
                
              
            });
        });
    }


//jw
    function drawjwOnMap(tanks) {
        tanks.forEach(tank => {
            // Create a marker for each tank
            var tankMarker = new google.maps.Marker({
                position: { lat: parseFloat(tank.latitude), lng: parseFloat(tank.longitude) },
                map: map,
                title:  "Number: " + tank.jw_no + "\n" + "Name: " + tank.jw_name + "\n" + "Position :" + tank.jw_position + "\n" + "Address: " + tank.jw_address,
                icon: '{% static 'jw.png' %}',  // Use the appropriate tank icon
                // You may customize other properties of the marker as needed
            });

          
            // Add click event listener to the tank marker
            tankMarker.addListener('click', function() {
                //alert("Tank selected: " );
                if (confirm("Do You Want To Select This jw ?")) {
                // Clear previous lines if any
                clearLines();
    
                // Add the tank marker as the first marker
                selectedMarkers = [tankMarker];
                currentMarkerType = "jw";

                pipe_material.push(null);
                pipe_diameter.push(null);

                valve_diameter.push(null);
                valve_key_size.push(null);
                valve_type.push(null);

                // Start drawing a line from this tank
                startLineFromTank(tankMarker.getPosition());
                }
                else{

                }
                
                
              
            });
        });
    }
//

//wtp


    function drawwtpOnMap(tanks) {
        tanks.forEach(tank => {
            // Create a marker for each tank
            var tankMarker = new google.maps.Marker({
                position: { lat: parseFloat(tank.latitude), lng: parseFloat(tank.longitude) },
                map: map,
                title:  "Number: " + tank.wtp_no + "\n" + "Name: " + tank.wtp_name + "\n" + "Position :" + tank.wtp_position + "\n" + "Address: " + tank.wtp_address,
                icon: '{% static 'wtp.png' %}',  // Use the appropriate tank icon
                // You may customize other properties of the marker as needed
            });

        
            // Add click event listener to the tank marker
            tankMarker.addListener('click', function() {
                //alert("Tank selected: " );
                if (confirm("Do You Want To Select This WTP ?")) {
                // Clear previous lines if any
                //clearLines();

                // Add the tank marker as the first marker
                selectedMarkers = [tankMarker];
                currentMarkerType = "wtp";

                pipe_material.push(null);
                pipe_diameter.push(null);

                valve_diameter.push(null);
                valve_key_size.push(null);
                valve_type.push(null);

                // Start drawing a line from this tank
                startLineFromTank(tankMarker.getPosition());
                }
                else{

                }
                
                
            
            });
        });
    }


// booster

    function drawboosterOnMap(tanks) {
        tanks.forEach(tank => {
            // Create a marker for each tank
            var tankMarker = new google.maps.Marker({
                position: { lat: parseFloat(tank.latitude), lng: parseFloat(tank.longitude) },
                map: map,
                title:  "Number: " + tank.booster_no + "\n" + "Name: " + tank.booster_name + "\n" + "Position :" + tank.booster_position + "\n" + "Address: " + tank.booster_address,
                icon: '{% static 'booster.png' %}',  // Use the appropriate tank icon
                // You may customize other properties of the marker as needed
            });

        
            // Add click event listener to the tank marker
            tankMarker.addListener('click', function() {
                //alert("Tank selected: " );
                if (confirm("Do You Want To Select This Booster ?")) {
                // Clear previous lines if any
                //clearLines();

                // Add the tank marker as the first marker
                selectedMarkers = [tankMarker];
                currentMarkerType = "booster";

                pipe_material.push(null);
                pipe_diameter.push(null);

                valve_diameter.push(null);
                valve_key_size.push(null);
                valve_type.push(null);

                // Start drawing a line from this tank
                startLineFromTank(tankMarker.getPosition());
                }
                else{

                }
                
                
            
            });
        });
    }




    function drawLinesBetweenMarkers(markersByPath) {

        for (var pathId in markersByPath) {
            var pathPoints = markersByPath[pathId];
            var path = [];
            pathPoints.forEach(point => {
                path.push({ lat: point[0], lng: point[1] });
            });

            var line = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#004eff', // Change the stroke color if needed
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map
            });
            lines.push(line);
        }
    }



    //to clear prev lines
    
    function clearLines() {
        for (var i = 0; i < lines.length; i++) {
            lines[i].setMap(null);
        }
        lines = [];
    }
    
    function startLineFromTank(tankPosition) {
        google.maps.event.addListenerOnce(map, 'click', function (event) {
            var line = new google.maps.Polyline({
                path: [tankPosition, event.latLng],
                geodesic: true,
                strokeColor: '#ff8f00',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map
            });
            lines.push(line);
        });
    }
    


    // draw line between saved marker


    function addStoredMarker(latitude, longitude, type, path_id, point_id) {
        var iconUrl = getIconForType(type);
        var marker = new google.maps.Marker({
            position: { lat: latitude, lng: longitude },
            map: map,
            draggable: false, // Assuming stored markers are not draggable
            icon: iconUrl,
            pathId: path_id, // Set the path ID here
            pointId: point_id // Set the point ID here
        });

        markers.push(marker);

        marker.addListener('click', function () {
            handleMarkerClick(marker);
        });
    }



    //

    

    function addMarker(location, type) {
        var info = { type: type };
        if (type === 'valve') {
            info.name = "v1";
            
            showvModalPopupv();
            
        } else if (type === 'pipe') {
            info.pipeType = "p1";

            showModalPopup();
        }
        else if(type === 'branch')
        {
            type = 'branch';
            
            pipe_material.push(null)
            pipe_diameter.push(null)
            valve_type.push(null);
            valve_diameter.push(null);
            valve_key_size.push(null);

        }
        else if(type === 'valve_diameter')
        {

            type = 'valve_diameter';

        }
    
        // Set marker type to 'tank' if it is 'None'
        if (type === 'None') {
            type = 'tank';

            pipe_material.push(null)
            pipe_diameter.push(null)
            valve_type.push(null);
            valve_diameter.push(null);
            valve_key_size.push(null);
        }
    
        var marker = new google.maps.Marker({
            position: location,
            map: map,
            draggable: true,
            animation: google.maps.Animation.DROP,
            icon: getIconForType(type),
            info: info
        });
    
        selectedMarkers.push(marker);
    
        if (selectedMarkers.length > 1) {
            // Draw line between the newly added marker and the previous marker
            var previousMarker = selectedMarkers[selectedMarkers.length - 2];
            var line = new google.maps.Polyline({
                path: [previousMarker.getPosition(), location],
                geodesic: true,
                strokeColor: '#ff8f00',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map
            });
            lines.push(line);
        }
    
        addToUndoStack({ action: 'add', marker: marker });
    
        clearRedoStack();
    }
    

    




    function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
        for (var j = 0; j < lines.length; j++) {
            lines[j].setMap(null);
        }
        lines = [];
        undoStack = [];
        redoStack = [];
        latitudeList = [];
        longitudeList = [];
    }

    function undo() {
        if (undoStack.length === 0) {
            return;
        }
        var action = undoStack.pop();
        if (action.action === 'add') {
            action.marker.setMap(null);
            markers.pop();
            latitudeList.pop();
            longitudeList.pop();
            if (action.line) {
                action.line.setMap(null);
                lines.pop();
            }
            addToRedoStack(action);
        }
    }

    function redo() {
        if (redoStack.length === 0) {
            return;
        }
        var action = redoStack.pop();
        if (action.action === 'add') {
            action.marker.setMap(map);
            markers.push(action.marker);
            latitudeList.push(action.marker.getPosition().lat());
            longitudeList.push(action.marker.getPosition().lng());
            if (action.line) {
                action.line.setMap(map);
                lines.push(action.line);
            }
            addToUndoStack(action);
        }
    }

    function addToUndoStack(action) {
        undoStack.push(action);
    }

    function addToRedoStack(action) {
        redoStack.push(action);
    }

    function clearRedoStack() {
        redoStack = [];
    }

    function getIconForType(type) {
        switch (type) {
            case 'switch_valve':
                return '{% static 'valve.png' %}';

            case 'valve':
                return '{% static 'valve.png' %}'; // Valve icon
            case 'branch':
                return '{% static 'branch.png' %}'; // Branch icon
            case 'pipe':
                return '{% static 'pipe.png' %}'; // Pipe icon

            case 'tank':
                return '{% static 'tank.png' %}';
        
            case 'start':

                return 'None';

            case 'None':
                return  'None';
                
            default:
                return null;
        }
    }

    

    function displayResults() {
        console.log("Selected Markers: ", selectedMarkers);
    
        // Remove duplicate markers based on latitude and longitude
        var uniqueSelectedMarkers = [];
        var addedLatLngs = {}; // Track added latLng combinations
        selectedMarkers.forEach(function(marker) {
            var latLngKey = marker.getPosition().lat() + "," + marker.getPosition().lng();
            if (!addedLatLngs.hasOwnProperty(latLngKey)) {
                uniqueSelectedMarkers.push(marker);
                addedLatLngs[latLngKey] = true;
            }
        });
    
        // Extract latitude, longitude, and type from selected markers
        var selectedMarkersData = uniqueSelectedMarkers.map(function(marker) {
            var data = {
                latitude: marker.getPosition().lat(),
                longitude: marker.getPosition().lng(),
            };
            data.type = marker.info ? marker.info.type : null; // Assuming type is stored in the marker's info property
            return data;
        });
    
        // Save selected markers
        fetch('/save_markers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token if required
            },
            body: JSON.stringify({
                markers: selectedMarkersData,
                pipe_material: pipe_material,
                pipe_diameter: pipe_diameter,
                valve_type: valve_type,
                valve_diameter: valve_diameter,
                valve_key_size: valve_key_size,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Selected markers saved successfully!');
                alert('Saved Successfully');
                location.reload();
                console.log(selectedMarkersData);
            } else {
                console.error('Error saving selected markers:', data.error);
                alert('Error saving selected markers:', data.error);
            }
        })
        .catch(error => {
            console.error('Error sending AJAX request:', error);
        });
    }
    
    


    // Function to handle marker clicks

    function handleMarkerClick(marker) {
        // Get marker path ID and point ID
        var pathId = marker.pathId;
        var pointId = marker.pointId;
        up_path_id = pathId;
        up_index = pointId;

       
       
        console.log('Marker clicked! Path ID:', up_path_id, 'Point ID:', up_index);
        //alert('Marker clicked!');
        if (confirm("Do You Want To Select This Marker ?")) {
            selectedMarker = marker; 

            google.maps.event.addListenerOnce(map, 'click', function (event) {
                drawLineFromSelectedMarker(event.latLng);
            });

            // Increment pointId
            var newPointId = pointId + 1; // Assuming pointId is a numeric value

            // Call a function to extend the marker or line with the new pointId
            extendMarkerOrLine(marker, newPointId);

        }
        else {

        }
        

        
        //for branch

        // Check if the clicked marker is of type "branch"
        if (marker.info && marker.info.type === 'branch') {
            // Listen for a click event on the map to draw a line from the "branch" marker
            google.maps.event.addListenerOnce(map, 'click', function (event) {
                drawLineFromBranch(marker, event.latLng);
            });
        }
        
    }


    function drawLineFromSelectedMarker(position) {
        if (selectedMarker) {
            var line = new google.maps.Polyline({
                path: [selectedMarker.getPosition(), position],
                geodesic: true,
                strokeColor: '#ff8f00',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map
            });
            lines.push(line);

            addToUndoStack({ action: 'add', line: line });

            clearRedoStack();
        }
    }

    // Function to extend the marker or line with a new pointId
    // Function to extend the marker or line with a new pointId
    function extendMarkerOrLine(marker, newPointId) {
        // Here you can implement the logic to extend the marker or line with the new pointId
        // For example, if you want to extend the line:
        // Find the line associated with the marker
        var associatedLine = findLineByMarker(marker);
        if (associatedLine) {
            // Extend the line by adding a new point with the newPointId
            var newPath = associatedLine.getPath();
            newPath.push(marker.getPosition());

            // Update the marker's pointId
            marker.pointId = newPointId;

            // Send an AJAX request to save the updated marker's pointId
            saveMarkerPointId(marker, newPointId);
        }

        // You can add similar logic for extending the marker itself
    }



    function saveMarkerPointId(marker, newPointId) {
        fetch('/update_marker_point', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token if required
            },
            body: JSON.stringify({
                marker_id: marker.id,
                new_point_id: newPointId,
                path_id: marker.pathId,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Marker pointId updated successfully:', marker.id);
                // Update the marker's pointId
                marker.pointId = newPointId;
            } else {
                console.error('Error updating marker pointId:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating marker pointId:', error);
        });
    }



    function findLineByMarker(marker) {
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            if (line.getPath().getArray().includes(marker.getPosition())) {
                return line;
            }
        }
        return null;
    }


    function extend_path() {
        console.log("Selected Markers: ", selectedMarkers);
    


        // Extract latitude, longitude, and type from selected markers
        // Extract latitude, longitude, and type from selected markers
        var selectedMarkersData = selectedMarkers.map(function (marker) {
            var data = {
                latitude: marker.getPosition().lat(),
                longitude: marker.getPosition().lng(),
            };

            // Check if is_tank is equal to "yes"
           
                 // If is_tank is not "yes", set the type based on marker's type
                data.type = marker.info.type; // Assuming type is stored in the marker's info property
        

            return data;
        });


        // Save selected markers
        fetch('/extend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token if required
            },
            body: JSON.stringify({
                markers: selectedMarkersData,
                up_index:up_index,
                up_path_id:up_path_id,

                pipe_material: pipe_material,
                pipe_diameter: pipe_diameter,
                valve_type: valve_type,
                valve_diameter: valve_diameter,
                valve_key_size: valve_key_size,

            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Selected markers saved successfully!');
                    alert('Extended successfully');
                    location.reload();

                    console.log(selectedMarkersData);
                } else {
                    console.error('Error saving selected markers:', data.error);
                    alert('Error saving selected markers');

                }
            })
            .catch(error => {
                console.error('Error sending AJAX request:', error);
            });
    }

    

    function delete_marker() {
        

        if (confirm("are you  sure to remove this point?") == true) {
            window.location.href='/delete_marker/'+up_path_id+"/"+up_index;
            
          } else {
            text = "You canceled!";
          }


    }



    //for branch

    function addBranchMarkerListeners() {
        google.maps.event.addListener(map, 'click', function (event) {
            if (extend_signal == 1) {

                extend_signal = 0;
            }
            else {
                // Handle click event
                if (is_tank == true) {

                    is_tank = false;
                } else {

                    var locationType = document.getElementById('locationType').value;
                    if (locationType === 'cancel') {
                        return;
                    }

                    currentMarkerType = locationType; // Update the currentMarkerType

                    addMarker(event.latLng, locationType);
                }
            }
        });

        google.maps.event.addListener(map, 'rightclick', function (event) {
            is_tank = true;
            if (extend_signal == 1) {

                extend_signal = 0;
            }
            else {
                // Handle right-click event
                var locationType = document.getElementById('locationType').value;
                if (locationType === 'cancel') {
                    return;
                }

                currentMarkerType = locationType; // Update the currentMarkerType

                addMarker(event.latLng, locationType);

                
            }

        });
    }


    // Save branch marker function

    function saveBranch() {
        // Extract latitude, longitude, and type from selected markers
        var selectedMarkersData = selectedMarkers.map(function (marker) {
            var data = {
                latitude: marker.getPosition().lat(),
                longitude: marker.getPosition().lng(),
                type: marker.info.type, // Assuming type is stored in the marker's info property
                
            };
            return data;
        });

        // Save branch markers
        fetch('/save_branch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token if required
            },
            body: JSON.stringify({
                markers: selectedMarkersData,
                up_index:up_index,
                up_path_id:up_path_id,

                pipe_material: pipe_material,
                pipe_diameter: pipe_diameter,
                valve_type: valve_type,
                valve_diameter: valve_diameter,
                valve_key_size: valve_key_size,
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Branch markers saved successfully!');
                    alert('Branch saved successfully!');
                    location.reload();
                } else {
                    console.error('Error saving branch markers:', data.error);
                }
            })
            .catch(error => {
                console.error('Error sending AJAX request:', error);
            });
    }






// Function to show the modal popup
    function showModalPopup() {
        var modal = document.getElementById('pipeModal');
        modal.style.display = 'block';
    }

    // Save additional information when "Save" button is clicked
  

    document.getElementById('savePipeInfo').addEventListener('click', function() {
        var pipeType = document.getElementById('pipeType').value;
        var pipeDiameter = document.getElementById('pipeDiameter').value;
    
        if (pipeType.trim() !== '' && pipeDiameter.trim() !== '') {
            // If both fields are filled, proceed with saving
            console.log(getpip_type(pipeType, pipeDiameter));
    
            valve_type.push(null);
            valve_diameter.push(null);
            valve_key_size.push(null);
    
            pipe_material.push(getpip_type(pipeType));
            pipe_diameter.push(getpip_dim(pipeDiameter));
    
            // Close modal popup
            var modal = document.getElementById('pipeModal');
            modal.style.display = 'none';
        } else {
            // If any field is empty, show a warning message
            alert('Please fill out all fields.');
        }
    });

    // Function to save marker with additional information
    function getpip_type(pipeType) {
        // Add logic to save the marker along with additional information (pipeType and pipeDiameter)
        // This might involve sending an AJAX request to the server.
    
        var pip_type = pipeType;
        return pip_type;
    }


    function getpip_dim(pipeDiameter) {
        // Add logic to save the marker along with additional information (pipeType and pipeDiameter)
        // This might involve sending an AJAX request to the server.
        
        var pipe_diameter = pipeDiameter;
        return pipe_diameter;
    }


//for valve 


function showvModalPopupv() {
    var modal = document.getElementById('vModal');
    modal.style.display = 'block';
}

// Save additional information when "Save" button is clicked
/*document.getElementById('savevInfo').addEventListener('click', function() {
    var valve_type_input = document.getElementById('valve_type').value;
    var valve_diameter_input = document.getElementById('valve_diameter').value;
    var valve_key_size_input = document.getElementById('valve_key_size').value;

    

    // Save pipe type and diameter along with marker data
    //saveMarkerWithAdditionalInfo(pipeType, pipeDiameter);
  
    pipe_material.push(null);
    pipe_diameter.push(null);
    
    // Push values into respective arrays
    valve_type.push(get_valve_type(valve_type_input));
    valve_diameter.push(get_valve_diameter(valve_diameter_input));
    valve_key_size.push(get_valve_key_size(valve_key_size_input));

    // Close modal popup
    var modal = document.getElementById('vModal');
    modal.style.display = 'none';
});*/

document.getElementById('savevInfo').addEventListener('click', function() {
    var valve_type_input = document.getElementById('valve_type').value;
    var valve_diameter_input = document.getElementById('valve_diameter').value;
    var valve_key_size_input = document.getElementById('valve_key_size').value;

    if (valve_type_input.trim() !== '' && valve_diameter_input.trim() !== '' && valve_key_size_input.trim() !== '') {
        // If all fields are filled, proceed with saving
        pipe_material.push(null);
        pipe_diameter.push(null);

        // Push values into respective arrays
        valve_type.push(get_valve_type(valve_type_input));
        valve_diameter.push(get_valve_diameter(valve_diameter_input));
        valve_key_size.push(get_valve_key_size(valve_key_size_input));

        // Close modal popup
        var modal = document.getElementById('vModal');
        modal.style.display = 'none';
    } else {
        // If any field is empty, show a warning message
        alert('Please fill out all fields.');
    }
});

// Function to save marker with additional information
function get_valve_type(valve_type) {
    // Add logic to save the marker along with additional information (pipeType and pipeDiameter)
    // This might involve sending an AJAX request to the server.

    var valve_type= valve_type;
    return valve_type;
}


function get_valve_diameter(valve_diameter) {
    // Add logic to save the marker along with additional information (pipeType and pipeDiameter)
    // This might involve sending an AJAX request to the server.
    
    var valve_diameter = valve_diameter;
    return valve_diameter;
}

function get_valve_key_size(valve_key_size) {
    // Add logic to save the marker along with additional information (pipeType and pipeDiameter)
    // This might involve sending an AJAX request to the server.
    
    var valve_key_size = valve_key_size;
    return valve_key_size;
}


// Get the close buttons and attach click event listeners to them
var closeButtons = document.querySelectorAll('.close');
closeButtons.forEach(function(button) {
    button.addEventListener('click', function() {
        var modal = button.closest('.modal'); // Find the parent modal element
        modal.style.display = 'none'; // Hide the modal
        
        location.reload();
    });
});

// Get the Done buttons and attach click event listeners to them
document.getElementById('savePipeInfo').addEventListener('click', function() {
    
    // Your logic for saving pipe information goes here
    var pipeModal = document.getElementById('pipeModal');
    pipeModal.style.display = 'none'; // Hide the modal

});

document.getElementById('savevInfo').addEventListener('click', function() {
    redo();
    // Your logic for saving valve information goes here
    var vModal = document.getElementById('vModal');
    vModal.style.display = 'none'; // Hide the modal
});


</script>


 
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdGAjzYAR434EVUQDnB-L0N2nZ47Itq2c&callback=initMap"></script>
    

</body>

</html>
