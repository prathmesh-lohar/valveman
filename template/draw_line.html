<!DOCTYPE html>
<html>

<head>
    <title>Google Maps Location Selection Example</title>
    {% load static %}
    <style>
       
    </style>
    {% comment %} <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script> {% endcomment %}

    <script src="{% static '/js/drawline.js' %}"></script>

    <link rel="stylesheet" href="{% static '/css/style.css' %}">

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAdGAjzYAR434EVUQDnB-L0N2nZ47Itq2c&callback=initMap"></script>
    
     <!-- Font Awesome -->
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
     <!-- Google Fonts -->
     <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
 
     <!-- Font Awesome -->
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
     <!-- Google Fonts -->
     <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
     <!-- MDB -->
     <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/7.1.0/mdb.min.css" rel="stylesheet" />

</head>

<body onload="myFunction()">


    <nav class="navbar navbar-expand-lg navbar-light bg-body-tertiary ">
        <!-- Container wrapper -->
        <div class="container-fluid mx-1">
          <!-- Toggle button -->
          <button
            data-mdb-collapse-init
            class="navbar-toggler"
            type="button"
            data-mdb-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <i class="fas fa-bars"></i>
          </button>
      
          <!-- Collapsible wrapper -->
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Navbar brand -->
            <a class="navbar-brand mt-2 mt-lg-0" href="#">
              <img
                src="{% static 'logo.png' %}"
                height="30"
                alt="MDB Logo"
                loading="lazy"
              />
            </a>
            <!-- Left links -->
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link" href="">All Tanks</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/draw_line">Draw Line</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/logout">logout</a>
              </li>
            </ul>
            <!-- Left links -->
          </div>
          <!-- Collapsible wrapper -->
      
          <!-- Right elements -->
          <div class="d-flex align-items-center">
            <!-- Icon -->
            <a class="text-reset me-3" href="#">
              <i class="fas fa-gear"></i>
            </a>
      
            <!-- Notifications -->
            <div class="dropdown">
              <a
                data-mdb-dropdown-init
                class="text-reset me-3 dropdown-toggle hidden-arrow"
                href="#"
                id="navbarDropdownMenuLink"
                role="button"
                aria-expanded="false"
              >
                <i class="fas fa-bell"></i>
                <span class="badge rounded-pill badge-notification bg-danger">1</span>
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdownMenuLink"
              >
                <li>
                  <a class="dropdown-item" href="#">Some news</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Another news</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Something else here</a>
                </li>
              </ul>
            </div>
            <!-- Avatar -->
            <div class="dropdown">
              <a
                data-mdb-dropdown-init
                class="dropdown-toggle d-flex align-items-center hidden-arrow"
                href="#"
                id="navbarDropdownMenuAvatar"
                role="button"
                aria-expanded="false"
              >
                <img
                  src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp"
                  class="rounded-circle"
                  height="25"
                  alt="Black and White Portrait of a Man"
                  loading="lazy"
                />
              </a>
              <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="navbarDropdownMenuAvatar"
              >
                <li>
                  <a class="dropdown-item" href="#">My profile</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Settings</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">Logout</a>
                </li>
              </ul>
            </div>
          </div>
          <!-- Right elements -->
        </div>
        <!-- Container wrapper -->
      </nav>
      <!-- Navbar -->
    


    <div id="map"></div>


    {% if messages %}
    <ul class="messages" >
        {% for message in messages %}
            {% comment %} <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li> {% endcomment %}

            <!-- The actual snackbar -->
            <div id="snackbar" >{{ message }}</div>
        {% endfor %}
    </ul>
    {% endif %}



    <div class="fixed-bottom mx-2" >


        <div id="controls">
            <label>Select location type:</label>
            <select id="locationType">
                <option value="valve">Valve</option>
                <option value="branch">Branch</option>
                <option value="pipe">Pipe</option>
            </select>
        </div>

        
        <button class="btn btn-outline-dark my-2" onclick="undo()"><span class="fa fa-undo"></button>
        <button class="btn btn-outline-dark my-2" onclick="redo()"><span class="fa fa-redo"></button>
        <button class="btn btn-danger my-2" onclick="clearMarkers()">Clear All</button>
    
        <button class="btn btn-primary my-2" onclick="location.reload();">Refresh</button>
    
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
    
    
        <button class="btn btn-success my-2" onclick="displayResults()">Save</button>
        <button class="btn btn-info my-2" onclick="extend_path()">Extend</button>
       
    
        <!-- New button to save branch -->
        <button class="btn btn-warning my-2" onclick="saveBranch()">Save Branch</button>
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        &nbsp;
        <button class="btn btn-danger my-2" onclick="delete_marker()">Delete</button>

        <!-- Use a button to open the snackbar -->



    
     

    </div>

    



<script>

    var map;
    var markers = [];
    var lines = [];
    var undoStack = [];
    var redoStack = [];
    var latitudeList = [];
    var longitudeList = [];
    var type = [];

    var positions = [];

    var currentMarkerType; // Global variable to store the type of the current marker


    //for index and path

    var up_index;
    var up_path_id;
    var extend_signal;

    var is_tank;

    var clicked_branch;

    
    
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {
                lat: 20.9025, // Latitude of Dhule, Maharashtra
                lng: 74.7774 // Longitude of Dhule, Maharashtra
            },
            zoom: 13,
            mapTypeControl: true,
            mapTypeId: google.maps.MapTypeId.HYBRID
        });

        fetchStoredMarkers();
        addBranchMarkerListeners();

        google.maps.event.addListener(map, 'click', function (event) {
            var locationType = document.getElementById('locationType').value;
            if (locationType === 'cancel') {
                return;
            }

            currentMarkerType = locationType; // Update the currentMarkerType

            addMarker(event.latLng, locationType);


        });



    }

    


    //show stored markers

    function fetchStoredMarkers() {
        fetch('/get_markers')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    data.markers.forEach(marker => {
                        addStoredMarker(marker.latitude, marker.longitude, marker.type, marker.path_id, marker.point_id);
                        drawLinesBetweenMarkers(data.markers_by_path);

                    });


                    // Draw lines between markers
                    drawTanksOnMap(data.all_tanks);

                    // Draw lines between markers

                } else {
                    console.error('Error fetching stored markers:', data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching stored markers:', error);
            });
    }


    //tanks

    function drawTanksOnMap(tanks) {
        tanks.forEach(tank => {
            // Create a marker for each tank
            var tankMarker = new google.maps.Marker({
                position: { lat: parseFloat(tank.latitude), lng: parseFloat(tank.longitude) },
                map: map,
                icon: '{% static 'tank.png' %}',  // Use the appropriate tank icon
                // You may customize other properties of the marker as needed
            });
    
            // Add click event listener to the tank marker
            tankMarker.addListener('click', function() {
                
                // Clear previous lines if any
                clearLines();
    
                // Add the tank marker as the first marker
                selectedMarkers = [tankMarker];
                currentMarkerType = "tank";
                // Start drawing a line from this tank
                startLineFromTank(tankMarker.getPosition());
            });
        });
    }
    



    function drawLinesBetweenMarkers(markersByPath) {

        for (var pathId in markersByPath) {
            var pathPoints = markersByPath[pathId];
            var path = [];
            pathPoints.forEach(point => {
                path.push({ lat: point[0], lng: point[1] });
            });

            var line = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: '#004eff', // Change the stroke color if needed
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map
            });
            lines.push(line);
        }
    }



    //to clear prev lines
    
    function clearLines() {
        for (var i = 0; i < lines.length; i++) {
            lines[i].setMap(null);
        }
        lines = [];
    }
    
    function startLineFromTank(tankPosition) {
        google.maps.event.addListenerOnce(map, 'click', function (event) {
            var line = new google.maps.Polyline({
                path: [tankPosition, event.latLng],
                geodesic: true,
                strokeColor: '#ff8f00',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map
            });
            lines.push(line);
        });
    }
    


    // draw line between saved marker


    function addStoredMarker(latitude, longitude, type, path_id, point_id) {
        var iconUrl = getIconForType(type);
        var marker = new google.maps.Marker({
            position: { lat: latitude, lng: longitude },
            map: map,
            draggable: false, // Assuming stored markers are not draggable
            icon: iconUrl,
            pathId: path_id, // Set the path ID here
            pointId: point_id // Set the point ID here
        });

        markers.push(marker);

        marker.addListener('click', function () {
            handleMarkerClick(marker);
        });
    }



    //

    var selectedMarkers = []; // Array to store selected markers


    function addMarker(location, type) {
        var info = { type: type };
        if (type === 'valve') {
            info.name = "v1";
            //info.keySize = "def";
            info.keySize = prompt("Please enter a value:");
        } else if (type === 'pipe') {
            info.pipeType = "p1";
            info.pipeSize = "def";
        }
    
        // Set marker type to 'tank' if it is 'None'
        if (type === 'None') {
            type = 'tank';
        }
    
        var marker = new google.maps.Marker({
            position: location,
            map: map,
            draggable: true,
            animation: google.maps.Animation.DROP,
            icon: getIconForType(type),
            info: info
        });
    
        selectedMarkers.push(marker);
    
        if (selectedMarkers.length > 1) {
            // Draw line between the newly added marker and the previous marker
            var previousMarker = selectedMarkers[selectedMarkers.length - 2];
            var line = new google.maps.Polyline({
                path: [previousMarker.getPosition(), location],
                geodesic: true,
                strokeColor: '#ff8f00',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map
            });
            lines.push(line);
        }
    
        addToUndoStack({ action: 'add', marker: marker });
    
        clearRedoStack();
    }
    

    




    function clearMarkers() {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
        markers = [];
        for (var j = 0; j < lines.length; j++) {
            lines[j].setMap(null);
        }
        lines = [];
        undoStack = [];
        redoStack = [];
        latitudeList = [];
        longitudeList = [];
    }

    function undo() {
        if (undoStack.length === 0) {
            return;
        }
        var action = undoStack.pop();
        if (action.action === 'add') {
            action.marker.setMap(null);
            markers.pop();
            latitudeList.pop();
            longitudeList.pop();
            if (action.line) {
                action.line.setMap(null);
                lines.pop();
            }
            addToRedoStack(action);
        }
    }

    function redo() {
        if (redoStack.length === 0) {
            return;
        }
        var action = redoStack.pop();
        if (action.action === 'add') {
            action.marker.setMap(map);
            markers.push(action.marker);
            latitudeList.push(action.marker.getPosition().lat());
            longitudeList.push(action.marker.getPosition().lng());
            if (action.line) {
                action.line.setMap(map);
                lines.push(action.line);
            }
            addToUndoStack(action);
        }
    }

    function addToUndoStack(action) {
        undoStack.push(action);
    }

    function addToRedoStack(action) {
        redoStack.push(action);
    }

    function clearRedoStack() {
        redoStack = [];
    }

    function getIconForType(type) {
        switch (type) {
            case 'valve':
                return '{% static 'valve.png' %}'; // Valve icon
            case 'branch':
                return '{% static 'branch.png' %}'; // Branch icon
            case 'pipe':
                return 'None'; // Pipe icon

            case 'tank':
                return '{% static 'tank.png' %}'

            case 'None':
                return  'None';
                
            default:
                return null;
        }
    }

    function displayResults() {
        console.log("Selected Markers: ", selectedMarkers);
    


        // Extract latitude, longitude, and type from selected markers
        var selectedMarkersData = selectedMarkers.map(function (marker) {
            
                var data = {
                    latitude: marker.getPosition().lat(),
                    longitude: marker.getPosition().lng(),
                };
            
              
                data.type = marker.info ? marker.info.type : null;// Assuming type is stored in the marker's info property
                
                
            
                return data;

        });

        // Save selected markers
        fetch('/save_markers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token if required
            },
            body: JSON.stringify({
                markers: selectedMarkersData,

            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Selected markers saved successfully!');
                    console.log(selectedMarkersData);
                } else {
                    console.error('Error saving selected markers:', data.error);
                }
            })
            .catch(error => {
                console.error('Error sending AJAX request:', error);
            });
    }

    // Function to handle marker clicks

    function handleMarkerClick(marker) {
        // Get marker path ID and point ID
        var pathId = marker.pathId;
        var pointId = marker.pointId;
        up_path_id = pathId;
        up_index = pointId;

       
       
        console.log('Marker clicked! Path ID:', up_path_id, 'Point ID:', up_index);
        alert('Marker clicked!');
        

        selectedMarker = marker; 

        google.maps.event.addListenerOnce(map, 'click', function (event) {
            drawLineFromSelectedMarker(event.latLng);
        });

        // Increment pointId
        var newPointId = pointId + 1; // Assuming pointId is a numeric value

        // Call a function to extend the marker or line with the new pointId
        extendMarkerOrLine(marker, newPointId);

        //for branch

        // Check if the clicked marker is of type "branch"
        if (marker.info && marker.info.type === 'branch') {
            // Listen for a click event on the map to draw a line from the "branch" marker
            google.maps.event.addListenerOnce(map, 'click', function (event) {
                drawLineFromBranch(marker, event.latLng);
            });
        }
        
    }


    function drawLineFromSelectedMarker(position) {
        if (selectedMarker) {
            var line = new google.maps.Polyline({
                path: [selectedMarker.getPosition(), position],
                geodesic: true,
                strokeColor: '#ff8f00',
                strokeOpacity: 1.0,
                strokeWeight: 2,
                map: map
            });
            lines.push(line);

            addToUndoStack({ action: 'add', line: line });

            clearRedoStack();
        }
    }

    // Function to extend the marker or line with a new pointId
    // Function to extend the marker or line with a new pointId
    function extendMarkerOrLine(marker, newPointId) {
        // Here you can implement the logic to extend the marker or line with the new pointId
        // For example, if you want to extend the line:
        // Find the line associated with the marker
        var associatedLine = findLineByMarker(marker);
        if (associatedLine) {
            // Extend the line by adding a new point with the newPointId
            var newPath = associatedLine.getPath();
            newPath.push(marker.getPosition());

            // Update the marker's pointId
            marker.pointId = newPointId;

            // Send an AJAX request to save the updated marker's pointId
            saveMarkerPointId(marker, newPointId);
        }

        // You can add similar logic for extending the marker itself
    }



    function saveMarkerPointId(marker, newPointId) {
        fetch('/update_marker_point', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token if required
            },
            body: JSON.stringify({
                marker_id: marker.id,
                new_point_id: newPointId,
                path_id: marker.pathId,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Marker pointId updated successfully:', marker.id);
                // Update the marker's pointId
                marker.pointId = newPointId;
            } else {
                console.error('Error updating marker pointId:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating marker pointId:', error);
        });
    }



    function findLineByMarker(marker) {
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            if (line.getPath().getArray().includes(marker.getPosition())) {
                return line;
            }
        }
        return null;
    }


    function extend_path() {
        console.log("Selected Markers: ", selectedMarkers);
    


        // Extract latitude, longitude, and type from selected markers
        // Extract latitude, longitude, and type from selected markers
        var selectedMarkersData = selectedMarkers.map(function (marker) {
            var data = {
                latitude: marker.getPosition().lat(),
                longitude: marker.getPosition().lng(),
            };

            // Check if is_tank is equal to "yes"
           
                 // If is_tank is not "yes", set the type based on marker's type
                data.type = marker.info.type; // Assuming type is stored in the marker's info property
        

            return data;
        });


        // Save selected markers
        fetch('/extend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token if required
            },
            body: JSON.stringify({
                markers: selectedMarkersData,
                up_index:up_index,
                up_path_id:up_path_id,

            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Selected markers saved successfully!');
                    console.log(selectedMarkersData);
                } else {
                    console.error('Error saving selected markers:', data.error);
                }
            })
            .catch(error => {
                console.error('Error sending AJAX request:', error);
            });
    }

    

    function delete_marker() {
        

        if (confirm("are you  sure to remove this point?") == true) {
            window.location.href='/delete_marker/'+up_path_id+"/"+up_index;
            
          } else {
            text = "You canceled!";
          }


    }



    //for branch

    function addBranchMarkerListeners() {
        google.maps.event.addListener(map, 'click', function (event) {
            if (extend_signal == 1) {

                extend_signal = 0;
            }
            else {
                // Handle click event
                if (is_tank == true) {

                    is_tank = false;
                } else {

                    var locationType = document.getElementById('locationType').value;
                    if (locationType === 'cancel') {
                        return;
                    }

                    currentMarkerType = locationType; // Update the currentMarkerType

                    addMarker(event.latLng, locationType);
                }
            }
        });

        google.maps.event.addListener(map, 'rightclick', function (event) {
            is_tank = true;
            if (extend_signal == 1) {

                extend_signal = 0;
            }
            else {
                // Handle right-click event
                var locationType = document.getElementById('locationType').value;
                if (locationType === 'cancel') {
                    return;
                }

                currentMarkerType = locationType; // Update the currentMarkerType

                addMarker(event.latLng, locationType);
            }

        });
    }


    // Save branch marker function

    function saveBranch() {
        // Extract latitude, longitude, and type from selected markers
        var selectedMarkersData = selectedMarkers.map(function (marker) {
            var data = {
                latitude: marker.getPosition().lat(),
                longitude: marker.getPosition().lng(),
                type: marker.info.type, // Assuming type is stored in the marker's info property
                
            };
            return data;
        });

        // Save branch markers
        fetch('/save_branch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'  // Add CSRF token if required
            },
            body: JSON.stringify({
                markers: selectedMarkersData,
                up_index:up_index,
                up_path_id:up_path_id,
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Branch markers saved successfully!');
                } else {
                    console.error('Error saving branch markers:', data.error);
                }
            })
            .catch(error => {
                console.error('Error sending AJAX request:', error);
            });
    }








    

</script>






<script>
    function myFunction() {
        // Get the snackbar DIV
        var x = document.getElementById("snackbar");
      
        // Add the "show" class to DIV
        x.className = "show";
      
        // After 3 seconds, remove the show class from DIV
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
      }

</script>


<style>

    /* The snackbar - position it at the bottom and in the middle of the screen */
#snackbar {
  visibility: hidden; /* Hidden by default. Visible on click */
  min-width: 250px; /* Set a default minimum width */
  margin-left: -125px; /* Divide value of min-width by 2 */
  background-color: #333; /* Black background color */
  color: #fff; /* White text color */
  text-align: center; /* Centered text */
  border-radius: 2px; /* Rounded borders */
  padding: 16px; /* Padding */
  position: fixed; /* Sit on top of the screen */
  z-index: 1; /* Add a z-index if needed */
  left: 50%; /* Center the snackbar */
  bottom: 30px; /* 30px from the bottom */
}

/* Show the snackbar when clicking on a button (class added with JavaScript) */
#snackbar.show {
  visibility: visible; /* Show the snackbar */
  /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
  However, delay the fade out process for 2.5 seconds */
  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

/* Animations to fade the snackbar in and out */
@-webkit-keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}

@keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}

@-webkit-keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}


</style>

</body>

</html>

